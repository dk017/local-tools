name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: website/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: python-backend/requirements.txt

      - name: Install Python dependencies
        run: |
          cd python-backend
          pip install -r requirements.txt

      - name: Install test dependencies
        run: |
          cd tests
          # Create package-lock.json if it doesn't exist for caching
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only || npm install
          else
            npm ci || npm install
          fi

      - name: Install Playwright browsers
        run: |
          cd tests
          npx playwright install --with-deps

      - name: Start backend server
        run: |
          cd python-backend
          python -m uvicorn api:app --host 0.0.0.0 --port 8000 &
          sleep 5
          # Verify backend is running
          curl -f http://localhost:8000/ || exit 1
        env:
          CORS_ORIGINS: "*"
          MAX_FILE_SIZE: "52428800"
          MAX_TOTAL_SIZE: "104857600"

      - name: Start frontend server
        run: |
          cd website
          npm install
          npm run build
          PORT=3000 npm start &
          sleep 15
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: http://localhost:8000
          NEXT_PUBLIC_LEMONSQUEEZY_CHECKOUT_URL: https://test.lemonsqueezy.com/checkout/buy/test

      - name: Run integration tests
        run: |
          cd tests
          # Create directories for test results
          mkdir -p test-results/html test-results/outputs
          npm run test:web -- --reporter=list
        env:
          CI: true
          WEB_BASE_URL: http://localhost:3000

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            tests/test-results/**/*
            tests/playwright-report/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: tests/test-results/html/**/*
          if-no-files-found: ignore
          retention-days: 7

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.HETZNER_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Hetzner
        run: |
          ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
            set -e
            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd ~/local-tools || { echo "âŒ Project directory not found!"; exit 1; }

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main || { echo "âŒ Git pull failed!"; exit 1; }

            # Stop containers
            echo "ðŸ›‘ Stopping containers..."
            docker compose -f docker-compose.prod.yml down || true

            # Rebuild containers
            echo "ðŸ”¨ Rebuilding containers..."
            docker compose -f docker-compose.prod.yml build --no-cache backend frontend || { echo "âŒ Build failed!"; exit 1; }

            # Start containers
            echo "â–¶ï¸ Starting containers..."
            docker compose -f docker-compose.prod.yml up -d || { echo "âŒ Start failed!"; exit 1; }

            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 10

            # Health check
            echo "ðŸ¥ Running health checks..."
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
            else
              echo "âš ï¸ Backend health check failed (may still be starting)"
            fi

            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Frontend health check passed"
            else
              echo "âš ï¸ Frontend health check failed (may still be starting)"
            fi

            # Show container status
            echo "ðŸ“Š Container status:"
            docker compose -f docker-compose.prod.yml ps

            echo "âœ… Deployment completed!"
          EOF

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code pulled from main branch" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker containers rebuilt" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Services restarted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Verify services are running: \`docker compose ps\`" >> $GITHUB_STEP_SUMMARY
          echo "- Check logs: \`docker compose logs -f\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test your site: https://localtools.pro" >> $GITHUB_STEP_SUMMARY
